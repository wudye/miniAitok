<!DOCTYPE html>
<html>
<head>
    <title>AI chat bot demo</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .chat-container { max-width: 600px; margin: 0 auto; }
        .messages { border: 1px solid #ddd; height: 400px; overflow-y: auto; padding: 10px; margin-bottom: 10px; }
        .input-area { display: flex; gap: 10px; }
        #messageInput { flex: 1; padding: 10px; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; cursor: pointer; }
        .message { margin: 5px 0; padding: 5px; }
        .user { background: #e3f2fd; }
        .assistant { background: #f3e5f5; }
    </style>
</head>
<body>
<div class="chat-container">
    <h2>AI chat bot demo</h2>
    <div id="messages" class="messages"></div>
    <div class="input-area">
        <input type="text" id="messageInput" placeholder="input message..." onkeypress="handleKeyPress(event)">
        <button onclick="sendMessage()">send</button>
    </div>
    <div>
        <label>
            <input type="checkbox" id="useContext" checked> with context
        </label>
        <span style="margin-left: 20px;">chat ID: <span id="conversationId">1</span></span>
    </div>
</div>

<script>
    let conversationId = 1;

    function handleKeyPress(event) {
        if (event.key === 'Enter') {
            sendMessage();
        }
    }

    function addMessage(content, type) {
        const messagesDiv = document.getElementById('messages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${type}`;
        messageDiv.textContent = content;
        messagesDiv.appendChild(messageDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    async function sendMessage() {
        const input = document.getElementById('messageInput');
        const message = input.value.trim();
        if (!message) return;

        const useContext = document.getElementById('useContext').checked;

        addMessage(`your: ${message}`, 'user');
        input.value = '';

        const requestData = {
            conversationId: conversationId,
            message: message,
            useContext: useContext
        };

        try {
            const response = await fetch('http://localhost:18020/web-api/v1/chat/stream', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'text/event-stream',
                    'Authorization': 'Bearer eyJraWQiOiI1ZTlkYTlkYi1lN2E1LTRjNWQtOTkzYy1hOTllNDM5MzgyMjEiLCJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJzdWIiOiJ0ZXN0MyIsImF1ZCI6ImFwcCIsImlzcyI6ImFpdG9rLW1lbWJlciIsImV4cCI6MTc2NjE0NTgwMywiaWF0IjoxNzY2MTQyMjAzLCJ1c2VyaWQiOiIzIiwidXNlcm5hbWUiOiJ0ZXN0MyJ9.NGdovXyqixeQBuqcOfbcHBa6rxJeo_4ExBdXjte7rZ0nmuVS7TtrFOpwetbJKg06QEQb7gibJFdB2H78GsY-fKcYmru70bZzASuWbD7PJtkR2Nmwwzo44jbHbTVoEl2szE3k6lN0yU3t91vEVTOEBOiZ7eL4I2bngQyw_Drmj9knVUwjZU3VvObIoxUeWu2538v9itPphhKmwxkT7v8Zc6S7hUq9y5DOmj0alOPjLsdvUead6Dyy0mxx4RUrH9bdomB0GDeG94itsb-Gw7ypEVImpEH_dOv824cYAp2Sn8GXc28e92WygyIULVV8AuYQyjvSq5gSARQ-6EmvzCCqXw'

                },
                body: JSON.stringify(requestData)
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let assistantMessage = '';

            const assistantDiv = document.createElement('div');
            assistantDiv.className = 'message assistant';
            assistantDiv.textContent = 'AI: ';
            document.getElementById('messages').appendChild(assistantDiv);

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                const chunk = decoder.decode(value);
                const lines = chunk.split('\n');

                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        try {
                            const data = JSON.parse(line.substring(6));
                            if (data.code === 200 && data.data) {
                                assistantMessage += data.data.content;
                                assistantDiv.textContent = 'AI: ' + assistantMessage;
                                document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
                            }
                        } catch (e) {
                            console.error('parse data fail:', e);
                        }
                    }
                }
            }
        } catch (error) {
            console.error('request fail:', error);
            addMessage(`error : ${error.message}`, 'assistant');
        }
    }
</script>
</body>
</html>
